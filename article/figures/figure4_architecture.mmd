%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e8f4f8', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#4a90a4', 'lineColor': '#4a90a4'}}}%%

flowchart TB
    subgraph input["Input Layer"]
        DSL["DSL Source Files<br/>(.ipf files)"]
        CLI["CLI Interface<br/>(ipflang.exe)"]
        UserInputs["User Inputs<br/>(JSON/Interactive)"]
    end

    subgraph engine["IPFLang Engine"]
        direction TB

        subgraph parsing["Parsing Stage"]
            Lexer["Lexer<br/>(Tokenization)"]
            Parser["Parser<br/>(AST Generation)"]
            Resolver["Resolver<br/>(Symbol Resolution)"]
        end

        subgraph typesystem["Type System"]
            TypeChecker["Type Checker"]
            CurrencyChecker["Currency Type Checker<br/>(161 ISO 4217 codes)"]
            TypeInference["Type Inference"]
        end

        subgraph analysis["Static Analysis"]
            Completeness["Completeness Checker<br/>(Gap Detection)"]
            Monotonicity["Monotonicity Checker<br/>(Trend Verification)"]
            DomainAnalyzer["Domain Analyzer<br/>(Boundary Values)"]
        end

        subgraph evaluation["Evaluation Engine"]
            Evaluator["Expression Evaluator"]
            CaseSelector["Case/Yield Selector"]
            Provenance["Provenance Tracker"]
        end
    end

    subgraph output["Output Layer"]
        FeeResult["Fee Calculation Result"]
        AuditTrail["Provenance Record"]
        VerificationReport["Verification Reports"]
        ErrorReport["Error Diagnostics"]
    end

    DSL --> Lexer
    CLI --> UserInputs
    UserInputs --> Evaluator

    Lexer --> Parser
    Parser --> Resolver
    Resolver --> TypeChecker
    TypeChecker --> CurrencyChecker
    CurrencyChecker --> TypeInference

    TypeInference --> Completeness
    TypeInference --> Monotonicity
    Completeness --> DomainAnalyzer
    Monotonicity --> DomainAnalyzer

    TypeInference --> Evaluator
    Evaluator --> CaseSelector
    CaseSelector --> Provenance

    Provenance --> FeeResult
    Provenance --> AuditTrail
    Completeness --> VerificationReport
    Monotonicity --> VerificationReport
    TypeChecker --> ErrorReport

    style engine fill:#f8f9fa,stroke:#4a90a4,stroke-width:2px
    style parsing fill:#e8f4f8,stroke:#4a90a4
    style typesystem fill:#e8f4f8,stroke:#4a90a4
    style analysis fill:#fff5e6,stroke:#ffa726
    style evaluation fill:#f0f7e6,stroke:#7cb342
    style input fill:#fff,stroke:#999
    style output fill:#fff,stroke:#999
